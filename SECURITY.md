# 보안 강화 문서

## 🛡️ 적용된 보안 조치

### 1. 다층 Rate Limiting

#### Tier 1: Per-IP Rate Limit
- **제한**: 1분당 10회 (IP + User-Agent 조합)
- **목적**: 개별 사용자의 과도한 요청 차단
- **우회 난이도**: 중간 (IP 변경 필요)

#### Tier 2: Global Rate Limit
- **제한**: 1분당 50회 (전체 서버)
- **목적**: 분산 봇넷 공격 방어
- **효과**: 1000개 IP에서 동시 공격 시에도 1분에 최대 50회만 API 호출

#### Tier 3: General Request Limit
- **제한**: 15분당 100회 (per IP)
- **목적**: 장기간 스크래핑 방지

### 2. CORS 화이트리스트

```javascript
허용 도메인:
- http://localhost:3000
- http://localhost:5173
- https://saju-nickname.vercel.app
- https://*.vercel.app
```

**차단되는 것들:**
- ❌ 다른 웹사이트에서 임베딩
- ❌ 브라우저 콘솔에서 직접 호출 (다른 사이트에서)
- ❌ 악의적인 스크래핑 사이트

### 3. 응답 캐싱

- **캐시 기간**: 1시간
- **최대 항목**: 1,000개
- **효과**: 같은 날짜 조회 시 API 호출 없이 즉시 응답

**시나리오:**
```
1990년 1월 1일 조회 (첫 요청) → API 호출
1990년 1월 1일 조회 (재요청) → 캐시에서 반환 (API 호출 없음)
```

### 4. 입력 유효성 검사

```javascript
연도: 1900 ~ 2100
월: 1 ~ 12
일: 1 ~ 31
```

**차단되는 것들:**
- ❌ SQL Injection 시도
- ❌ XSS 공격 시도
- ❌ 비정상 날짜 (예: 2024-13-40)

### 5. 요청 크기 제한

- **JSON 페이로드**: 최대 10KB
- **목적**: DDoS 공격 방어

---

## 💰 과금 시나리오 분석

### 시나리오 A: 정상 사용 (안전)
```
일일 방문자: 1,000명
평균 조회: 2회/인
총 API 호출: 2,000회/일
월 API 호출: 60,000회
```
**결과**: ✅ 안전 (공공 API 무료 한도 내)

---

### 시나리오 B: 인기 급상승 (주의)
```
일일 방문자: 10,000명
평균 조회: 3회/인
총 API 호출: 30,000회/일
월 API 호출: 900,000회
```
**현재 방어:**
- ✅ Rate Limiting: 1분당 최대 50회 = 시간당 3,000회
- ✅ 캐싱: 인기 날짜 반복 조회 시 API 호출 없음
- ✅ 실제 API 호출: 예상의 30~50% (캐싱 효과)

**결과**: ✅ 안전

---

### 시나리오 C: 분산 봇넷 공격 (위험 → 방어됨)

**공격 시나리오:**
```
공격자: 1,000개 서로 다른 IP
각 IP: 1분당 10회 요청
이론상 총 요청: 10,000회/분
```

**현재 방어 메커니즘:**

1. **Global Rate Limit 발동**
   - 1분당 최대 50회만 실제 API 호출
   - 나머지는 429 에러 반환

2. **캐시 히트**
   - 공격자가 같은 날짜 반복 시 캐시에서 반환
   - 실제 API 호출 0회

3. **최악의 경우 (모두 다른 날짜)**
   ```
   시간당 API 호출: 50 × 60 = 3,000회
   일일 API 호출: 72,000회
   월 API 호출: 2,160,000회
   ```

**결과**: ⚠️ 주의 필요 (API 쿼터 모니터링 권장)

---

### 시나리오 D: CORS 우회 스크래핑 (차단됨)

**공격 시나리오:**
```javascript
// 악의적 사이트 (evil-site.com)
fetch('https://saju-nickname.vercel.app/api/saju?...')
```

**현재 방어:**
- ❌ CORS 정책으로 브라우저에서 차단
- ✅ `Access-Control-Allow-Origin` 헤더 없음

**결과**: ✅ 완전 차단

---

## 📊 Vercel 과금 분석

### Vercel 무료 플랜 한도
- **함수 실행 시간**: 100 GB-Hours/월
- **대역폭**: 100 GB/월
- **함수 실행**: 제한 없음

### 예상 사용량 (최악의 경우)

**함수 실행:**
```
요청당 평균 실행 시간: 500ms
월 최대 요청: 2,160,000회 (봇넷 공격)
총 실행 시간: 1,080,000초 = 300시간
메모리 사용: 1024MB (1GB)
총 사용: 300 GB-Hours
```
**결과**: ⚠️ 무료 한도 초과 (3배)

### 대응 방안

1. **Global Rate Limit 강화**
   ```bash
   GLOBAL_API_LIMIT=30  # 50 → 30으로 감소
   ```

2. **Vercel Analytics 모니터링**
   - 실시간 함수 사용량 확인
   - 이상 트래픽 감지 시 즉시 대응

3. **긴급 차단 (수동)**
   - 환경변수 `GLOBAL_API_LIMIT=0` 설정
   - API 완전 차단 (점검 모드)

---

## 🚨 긴급 대응 가이드

### 1. 과도한 트래픽 감지 시

**Vercel Dashboard 확인:**
1. Functions 탭 → 실행 시간 확인
2. Analytics 탭 → 이상 트래픽 감지

**즉시 조치:**
```bash
# Vercel 환경변수 업데이트
GLOBAL_API_LIMIT=10  # 더 강력한 제한
RATE_LIMIT_MAX_REQUESTS=5  # Per-IP 제한 강화
```

### 2. API 키 도용 의심 시

**한국천문연구원 포털에서:**
1. 기존 API 키 삭제
2. 새 API 키 발급
3. Vercel 환경변수 업데이트

### 3. 서비스 완전 중단 필요 시

**긴급 차단:**
```bash
GLOBAL_API_LIMIT=0
```
모든 API 요청 즉시 차단

---

## ✅ 모니터링 체크리스트

### 일일 점검
- [ ] Vercel Functions 사용량 확인
- [ ] 이상 트래픽 패턴 감지
- [ ] 에러 로그 확인

### 주간 점검
- [ ] API 키 사용량 확인 (한국천문연구원)
- [ ] 캐시 히트율 확인 (X-Cache 헤더)
- [ ] Global Rate Limit 발동 횟수

### 긴급 상황 대응
1. Vercel Dashboard → Functions
2. 비정상 트래픽 감지 시
3. 환경변수로 즉시 제한 강화
4. 필요시 서비스 일시 중단

---

## 🔐 추가 보안 권장사항

### 1. Redis 캐싱 (프로덕션 권장)
현재는 메모리 캐시 (서버 재시작 시 사라짐)
→ **Redis** 사용 시 영구 캐싱 가능

### 2. Cloudflare 추가
- DDoS 방어 강화
- 무료 CDN 캐싱
- Bot 감지 및 차단

### 3. API 키 정기 교체
- 월 1회 API 키 재발급 권장
- 자동화 스크립트 구성 가능

### 4. 알림 설정
- Vercel Webhooks → Slack/Discord 연동
- 과도한 트래픽 감지 시 즉시 알림
